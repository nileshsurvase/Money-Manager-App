<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #dee2e6; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üóÑÔ∏è Database Setup & Test</h1>
    <p>This tool will help you initialize your Neon database and test the connection.</p>

    <div class="step">
        <h3>Step 1: Initialize Database Tables</h3>
        <button id="initDb" onclick="initializeDatabase()">Initialize Database</button>
        <div id="initStatus"></div>
    </div>

    <div class="step">
        <h3>Step 2: Test API Connection</h3>
        <button id="testApi" onclick="testApiConnection()">Test API</button>
        <div id="apiStatus"></div>
    </div>

    <div class="step">
        <h3>Step 3: Migrate Local Data</h3>
        <button id="migrateBtn" onclick="migrateLocalData()">Migrate Data to Server</button>
        <div id="migrateStatus"></div>
        <div id="migrationDetails"></div>
    </div>

    <script>
        // Configuration
        const API_BASE = '/.netlify/functions';

        // Show status
        function showStatus(elementId, message, type = 'loading') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // Initialize Database
        async function initializeDatabase() {
            showStatus('initStatus', 'üîÑ Initializing database tables...', 'loading');
            
            try {
                const response = await fetch('/.netlify/functions/init-db', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showStatus('initStatus', '‚úÖ Database tables created successfully!', 'success');
                } else {
                    showStatus('initStatus', `‚ùå Failed to initialize database: ${result.error || result.details}`, 'error');
                }
            } catch (error) {
                showStatus('initStatus', `‚ùå Error connecting to database: ${error.message}`, 'error');
            }
        }

        // Test API Connection
        async function testApiConnection() {
            showStatus('apiStatus', 'üîÑ Testing API endpoints...', 'loading');
            
            const testUserId = 'test-user-' + Date.now();
            
            try {
                // Test expenses endpoint
                const response = await fetch('/.netlify/functions/api/expenses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: testUserId,
                        amount: 100,
                        categoryId: 'food',
                        description: 'Test expense',
                        date: new Date().toISOString().split('T')[0]
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus('apiStatus', '‚úÖ API connection successful! Test expense created.', 'success');
                    
                    // Clean up test data
                    try {
                        await fetch(`/.netlify/functions/api/expenses/${result.id}`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId: testUserId })
                        });
                    } catch (e) {
                        console.log('Cleanup failed:', e);
                    }
                } else {
                    const error = await response.text();
                    showStatus('apiStatus', `‚ùå API test failed: ${error}`, 'error');
                }
            } catch (error) {
                showStatus('apiStatus', `‚ùå Network error: ${error.message}`, 'error');
            }
        }

        // Migrate Local Data
        async function migrateLocalData() {
            showStatus('migrateStatus', 'üîÑ Starting data migration...', 'loading');
            
            const migrationDetails = [];
            let totalItems = 0;
            let successCount = 0;
            
            try {
                const userId = 'migrated-user-' + Date.now();
                
                // Get all localStorage data
                const localData = {
                    expenses: JSON.parse(localStorage.getItem('money_manager_expenses') || '[]'),
                    budgets: JSON.parse(localStorage.getItem('money_manager_budgets') || '[]'),
                    diaryDaily: JSON.parse(localStorage.getItem('diary_daily_entries') || '[]'),
                    diaryWeekly: JSON.parse(localStorage.getItem('diary_weekly_entries') || '[]'),
                    diaryMonthly: JSON.parse(localStorage.getItem('diary_monthly_entries') || '[]'),
                    coreOSTasks: JSON.parse(localStorage.getItem('coreos_tasks') || '[]'),
                    coreOSHabits: JSON.parse(localStorage.getItem('coreos_habits') || '[]'),
                    coreOSFitness: JSON.parse(localStorage.getItem('coreos_fitness') || '[]'),
                    freedomOSNetworth: JSON.parse(localStorage.getItem('freedomos_networth') || '[]'),
                    freedomOSBudget: JSON.parse(localStorage.getItem('freedomos_budget') || '[]'),
                    freedomOSEmergency: JSON.parse(localStorage.getItem('freedomos_emergency') || '[]'),
                    freedomOSLoans: JSON.parse(localStorage.getItem('freedomos_loans') || '[]'),
                };

                // Count total items
                Object.values(localData).forEach(items => totalItems += items.length);
                
                if (totalItems === 0) {
                    showStatus('migrateStatus', '‚ö†Ô∏è No local data found to migrate.', 'error');
                    return;
                }

                migrationDetails.push(`Found ${totalItems} items to migrate:`);

                // Migrate expenses
                if (localData.expenses.length > 0) {
                    for (const expense of localData.expenses) {
                        try {
                            await fetch('/.netlify/functions/api/expenses', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ ...expense, userId })
                            });
                            successCount++;
                        } catch (e) {
                            console.error('Failed to migrate expense:', e);
                        }
                    }
                    migrationDetails.push(`- Expenses: ${localData.expenses.length}`);
                }

                // Migrate budgets
                if (localData.budgets.length > 0) {
                    for (const budget of localData.budgets) {
                        try {
                            await fetch('/.netlify/functions/api/budgets', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ ...budget, userId })
                            });
                            successCount++;
                        } catch (e) {
                            console.error('Failed to migrate budget:', e);
                        }
                    }
                    migrationDetails.push(`- Budgets: ${localData.budgets.length}`);
                }

                // Add more migration logic for other data types...
                migrationDetails.push(`- Diary entries: ${localData.diaryDaily.length + localData.diaryWeekly.length + localData.diaryMonthly.length}`);
                migrationDetails.push(`- CoreOS items: ${localData.coreOSTasks.length + localData.coreOSHabits.length + localData.coreOSFitness.length}`);
                migrationDetails.push(`- FreedomOS items: ${localData.freedomOSNetworth.length + localData.freedomOSBudget.length + localData.freedomOSEmergency.length + localData.freedomOSLoans.length}`);

                showStatus('migrateStatus', `‚úÖ Migration completed! ${successCount}/${totalItems} items migrated successfully.`, 'success');
                document.getElementById('migrationDetails').innerHTML = '<pre>' + migrationDetails.join('\n') + '</pre>';
                
            } catch (error) {
                showStatus('migrateStatus', `‚ùå Migration failed: ${error.message}`, 'error');
            }
        }

        // Auto-check on page load
        window.onload = function() {
            // Check if we have local data
            const hasLocalData = localStorage.getItem('money_manager_expenses') || 
                                localStorage.getItem('diary_daily_entries') || 
                                localStorage.getItem('coreos_tasks');
            
            if (hasLocalData) {
                document.querySelector('body').insertAdjacentHTML('afterbegin', 
                    '<div class="status success">‚úÖ Local data detected! Ready for migration.</div>'
                );
            } else {
                document.querySelector('body').insertAdjacentHTML('afterbegin', 
                    '<div class="status error">‚ö†Ô∏è No local data found. Make sure you\'re on the same domain as your app.</div>'
                );
            }
        };
    </script>
</body>
</html>